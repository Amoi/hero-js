<!doctype html>
<html>
<head>
    <script src="../../hero.js"></script>
    <script>

    var eth = window.eth;
    var contract = window.eth.contract(window.otcABI).at(window.otcAddress);

    function startCheckTx(txid, callback) {
        var txInterval = setInterval(async function() { 
            eth.getTransactionReceipt(txid).then(function(result){
                if (result) {
                    callback(result.status == '0x1');
                    clearInterval(txInterval);
                }
            })
        }, 2000);
    }
    
    var addOrderView = 
    {
        class: 'HeroView',
        hidden: true,
        frame: {w:'1x', h:'1x'},
        name: 'addOrderView',
        subViews: [
            {
                class: 'HeroView',
                frame: {w:'1x', h:'1x'},
                backgroundColor: '1E2027',
                alpha: 0.7
            },
            {
                class: 'HeroView',
                frame: {w:'300', h:'240'},
                backgroundColor: '222e3c',
                center: {x:'0.5x', y:'0.5x'},
                cornerRadius: 6,
                subViews: [
                    {
                        class: 'HeroLabel',
                        frame: {x:'15', y:'18'},
                        text: '下单',
                        size: 16,
                        textColor: 'ffffff'
                    },
                    {
                        class: 'HeroImageView',
                        frame: {y:'12', r:'12', w:'25', h:'25'},
                        image: path+'images/close.png'
                    },
                    {
                        class: 'HeroButton',
                        frame: {y:'12', r:'12', w:'25', h:'25'},
                        click: {click: 'closeOrderView'}
                    },
                    {
                        class: 'HeroLabel',
                        frame: {x:'15', y:'50'},
                        text: '币种',
                        size: 12,
                        textColor: '898989'
                    },
                    {
                        class: 'HeroLabel',
                        frame: {x:'17', y:'70', w:'100', h:'30'},
                        text: 'HER',
                        textColor: 'ffffff',
                        size: 13
                    },
                    {
                        class: 'HeroLabel',
                        frame: {x:'170', y:'50'},
                        text: '数量',
                        textColor: '898989',
                        size: 12
                    },
                    {
                        class: 'HeroTextField',
                        frame: {x:'170', y:'75', w:'100', h:'20'},
                        cornerRadius: '4',
                        backgroundColor: '222e3c',
                        name: 'amountTextField'
                    },
                    {
                        class: 'HeroLabel',
                        frame: {x:'15', y:'100'},
                        text: '单价',
                        textColor: '898989',
                        size: 12
                    },
                    {
                        class: 'HeroTextField',
                        frame: {x:'15', y:'125', w:'100', h:'20'},
                        cornerRadius: '4',
                        backgroundColor: '222e3c',
                        name: 'priceTextField'
                    },
                    {
                        class: 'HeroLabel',
                        frame: {x:'170', y:'100'},
                        text: '总价',
                        textColor: '898989',
                        size: 12
                    },
                    {
                        class: 'HeroTextField',
                        frame: {x:'170', y:'125', w:'100', h:'20'},
                        cornerRadius: 4,
                        backgroundColor: '22e3c',
                        name: 'totalTextField'
                    },
                    {
                        class: 'HeroImageView',
                        frame: {x:'15', y:'160', w:'15', h:'15'},
                        image: path+'images/dotSelect.png',
                        name: 'wantBuyImage'
                    },
                    {
                        class: 'HeroButton',
                        frame: {x:'15', y:'160', w:'15', h:'15'},
                        click: {click: 'wantBuy'}
                    },
                    {
                        class: 'HeroButton',
                        frame: {x:'28', y:'157', w:'50', h:'15'},
                        click: {click: 'wantBuy'},
                        title: '我想买',
                        titleColor: 'ffffff'
                    },
                    {
                        class: 'HeroLabel',
                        text: '(锁定ETH)',
                        size: 7,
                        textColor: '999999',
                        frame: {x:'72', y:'162'}
                    },
                    {
                        class: 'HeroImageView',
                        frame: {x:'140', y:'160', w:'15', h:'15'},
                        image: path+'images/dot.png',
                        name: 'wantSellImage'
                    },
                    {
                        class: 'HeroButton',
                        frame: {x:'140', y:'160', w:'15', h:'15'},
                        click: {click: 'wantSell'},
                    },
                    {
                        class: 'HeroButton',
                        frame: {x:'153', y:'157', w:'50', h:'15'},
                        click: {click: 'wantSell'},
                        title: '我想卖',
                        titleColor: 'ffffff'
                    },
                    {
                        class: 'HeroLabel',
                        text: '(锁定HER)',
                        size: 7,
                        textColor: '999999',
                        frame: {x:'197', y:'162'},
                        name: 'lockTokenLabel'
                    },
                    {
                        class: 'HeroButton',
                        frame: {b:'18', w:'100', h:'30', r:'30'},
                        ripple: true,
                        title:'确认',
                        backgroundColor:'47b3ea',
                        titleColor:'ffffff',
                        cornerRadius:16,
                        click:{click:'confirmOrder'}
                    },
                ]
            }
        ]
    }


    function getList(list, j) {
        contract.orderIDs(j).then(function(orderID){
            contract.orders(orderID).then(function(data) {
                order = JSON.parse(data);
                console.log(order);

                if (order.orderID == '0x') {
                    // No more data
                    Hero.rows = []
                    for (var i = 0; i < list.length; i++) {
                        var orderInList = list[i];
                        Hero.rows.push({
                            class: 'HeroView',
                            frame: {w:'1x', h:'50'},
                            subViews: [
                                {
                                    class: 'HeroLabel',
                                    text: orderInList.tokenName,
                                    
                                }
                            ]
                        })
                }
                } else {
                    // add order to list
                    tokenContract = eth.contract(erc20ABI).at(order.token);
                    tokenContract.symbol.then(function(tokenName){
                        list.push({
                            symbol: tokenName,
                            amountToken: order.amountToken,
                            price: order.amountETH / order.amountToken,
                            totalPrice: order.amountETH,
                            type: order.type,
                            orderID: order.orderID
                        })
                    });
                }
                
            });
        })
    }

    Hero.on = function(data){
        if (data.click === 'addOrder') {
            this.datas({name:'addOrderView', hidden:false});
        } else if (data.click === 'closeOrderView') {
            this.datas({name:'addOrderView', hidden:true});
        }
    };
    Hero.viewWillAppear = function() {

    };
    Hero.viewWillDisAppear = function() {

    };
    Hero.viewDidload = function() {
      

    };


    Hero.ui = {
        version:-1,
        tintColor:'4b5764',
        nav:{
            title:"去中心化交易",
            titleColor: 'ffffff',
            navigationBarHidden:true
        },
        views:
        [
            {
                // navigationbar
                class:'HeroView',
                frame: {w:'1x', h:'44'},
                backgroundColor: '000000',
                subViews:[
                    {
                        class: 'HeroImageView',
                        frame: {r:'8', w:'20', h:'20'},
                        center: {y:'0.5x'},
                        image: path+'images/add.png'
                    },
                    {
                        class: 'HeroButton',
                        frame: {r:'8', w:'20', h:'20'},
                        center: {y:'0.5x'},
                        click: {click:'addOrder'}
                    },
                    {
                        class: 'HeroButton',
                        frame: {x:'0.5x-80', w:'80', h:'40'},
                        center: {y:'0.5x'},
                        title: '购买',
                        click: {click:'naviBuy'},
                        backgroundColor: '767676',
                        ripple: true
                    },
                    {
                        class: 'HeroButton',
                        frame: {x:'0.5x',w:'80', h:'40'},
                        center: {y:'0.5x'},
                        title: '出售',
                        click: {click:'naviSell'},
                        backgroundColor: '3c4d56',
                        ripple: true
                    },
                ]
            },
            addOrderView
        ]
    };

    </script>
</body>
</html>
